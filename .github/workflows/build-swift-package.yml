name: Release iOS XCFramework

on:
  push:
    tags: 
      - 'v*'  # Trigger on version tags (e.g., v1.0.0)

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      # Step 1: Checkout code
      - uses: actions/checkout@v4

      # Step 2: Validate version format (ADD THIS STEP EARLY!)
      - name: Validate version format
        id: validate-version
        run: |
          if [[ ${{ github.event_name }} == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version_tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version must match 'vX.Y.Z' (e.g., v1.0.0). Got: $VERSION"
            exit 1
          fi
          echo "VERSION_VALIDATED=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Rust targets
        run: |
          rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim

      - name: Add UniFFI
        run: cargo add uniffi  

      - name: Build Rust libraries
        run: |
          # 1. Build all targets
          cargo build --release --target aarch64-apple-ios
          cargo build --release --target x86_64-apple-ios
          cargo build --release --target aarch64-apple-ios-sim
          
          # 2. Create directory structure FIRST
          mkdir -p target/universal-ios-sim/release
          
          # 3. Then run lipo
          lipo -create \
            target/x86_64-apple-ios/release/libcontext_runtime.a \
            target/aarch64-apple-ios-sim/release/libcontext_runtime.a \
            -output target/universal-ios-sim/release/libcontext_runtime.a
          
          # 4. Verify output
          file target/universal-ios-sim/release/libcontext_runtime.a

      - name: Inspect target directory
        run: |
          echo "=== Target directory structure ==="
          find target -type f -name "*.a" | grep -i context_runtime
          echo "================================"

      - name: Generate UniFFI bindings
        run: |
          cargo run --bin uniffi-bindgen generate --library target/aarch64-apple-ios/release/libcontext_runtime.a --language swift --out-dir out
          cargo run --bin uniffi-bindgen-swift -- target/aarch64-apple-ios/release/libcontext_runtime.a build/swift/Modules --xcframework --modulemap --modulemap-filename context.modulemap

      - name: Create XCFramework
        run: |
          mkdir -p xcframework/Headers
          cp out/*.h xcframework/Headers/
          cp out/*.modulemap xcframework/Headers/
          xcodebuild -create-xcframework \
              -library target/aarch64-apple-ios/release/libcontext_runtime.a \
              -headers xcframework/Headers \
              -library target/universal-ios-sim/release/libcontext_runtime.a \
              -headers xcframework/Headers \
              -output ContextRuntime.xcframework
          mkdir -p ContextRuntime.xcframework/swift-interfaces
          cp out/*.swift ContextRuntime.xcframework/swift-interfaces/

      - name: Zip XCFramework
        run: zip -r ContextRuntime.xcframework.zip ContextRuntime.xcframework

      - name: Create Swift Package
        run: |
          mkdir -p ContextRuntimeSPM/Sources/ContextRuntime
          cp -R out/*.swift ContextRuntimeSPM/Sources/ContextRuntime/
          cat > ContextRuntimeSPM/Package.swift <<EOF
          // swift-tools-version:5.9
          import PackageDescription
          
          let package = Package(
              name: "ContextRuntime",
              platforms: [.iOS(.v16)],
              products: [.library(name: "ContextRuntime", targets: ["ContextRuntime"])],
              targets: [
                  .binaryTarget(
                      name: "ContextRuntimeFFI",
                      url: "https://github.com/your/repo/releases/download/\${GITHUB_REF_NAME}/ContextRuntime.xcframework.zip",
                      checksum: "$(shasum -a 256 ContextRuntime.xcframework.zip | cut -d ' ' -f 1)"
                  ),
                  .target(
                      name: "ContextRuntime",
                      dependencies: ["ContextRuntimeFFI"],
                      path: "Sources/ContextRuntime",
                      swiftSettings: [
                          .enableExperimentalFeature("ForeignReferenceType")
                      ]
                  )
              ]
          )
          EOF

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            ContextRuntime.xcframework.zip
            ContextRuntimeSPM/Package.swift
